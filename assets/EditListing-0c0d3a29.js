import{P as me,t as Me,m as Le,c as Ne,R as Ee,u as ce,w as ve,r as Z,D as Ie,p as we,j as e,F as ie,E as he,B as K,G as Fe,H as Te,Q as X,g as re,I as qe}from"./index-660d126b.js";import{u as De,C as I}from"./index.esm-12fca3ed.js";import{u as oe}from"./useMutation-e7c8b84b.js";import{R as Y,C as T}from"./Col-95c4f5db.js";import{C as Pe}from"./Card-0007d0c0.js";import{C as be}from"./CardBody-ff2bad32.js";import{C as Re}from"./CardHeader-07a4f72e.js";import{F as Oe}from"./Form-d6175283.js";import{F as S,L as C}from"./Label-4c846b7c.js";import{U as J}from"./types-9dadba29.js";import{E as se}from"./ErrorDisplay-52780e50.js";import{S as Ue}from"./Spinner-f4f30a5b.js";import{G as F}from"./GenericInput-6d7d494b.js";import{c as pe,a as Qe,j as ke,e as $e}from"./jewelleryClasses-470ac029.js";import{D as B}from"./DisplayFormError-c2d4e36b.js";import{U as ge,a as Be}from"./UnitType-2ae5b94b.js";import{B as je}from"./Badge-d2d27bae.js";import{C as ze}from"./CardImg-423f9db5.js";import{I as Ae}from"./Input-fbe04029.js";var We=["className","cssModule","tag"];function le(){return le=Object.assign?Object.assign.bind():function(i){for(var m=1;m<arguments.length;m++){var c=arguments[m];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(i[d]=c[d])}return i},le.apply(this,arguments)}function _e(i,m){if(i==null)return{};var c=Ge(i,m),d,v;if(Object.getOwnPropertySymbols){var w=Object.getOwnPropertySymbols(i);for(v=0;v<w.length;v++)d=w[v],!(m.indexOf(d)>=0)&&Object.prototype.propertyIsEnumerable.call(i,d)&&(c[d]=i[d])}return c}function Ge(i,m){if(i==null)return{};var c={},d=Object.keys(i),v,w;for(w=0;w<d.length;w++)v=d[w],!(m.indexOf(v)>=0)&&(c[v]=i[v]);return c}var He={className:me.string,cssModule:me.object,tag:Me};function Se(i){var m=i.className,c=i.cssModule,d=i.tag,v=d===void 0?"div":d,w=_e(i,We),A=Le(Ne(m,"card-title"),c);return Ee.createElement(v,le({},w,{className:A}))}Se.propTypes=He;var Ce={exports:{}};(function(i,m){(function(c,d){i.exports=d()})(self,()=>(()=>{var c={d:(a,r)=>{for(var h in r)c.o(r,h)&&!c.o(a,h)&&Object.defineProperty(a,h,{enumerable:!0,get:r[h]})},o:(a,r)=>Object.prototype.hasOwnProperty.call(a,r),r:a=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(a,"__esModule",{value:!0})}},d={};function v(){return document.createElement("canvas")}function w(a){for(var r=atob(a.split(",")[1]),h=a.split(",")[0].split(":")[1].split(";")[0],s=new ArrayBuffer(r.length),j=new Uint8Array(s),u=0;u<r.length;u++)j[u]=r.charCodeAt(u);return new Blob([s],{type:h})}function A(a,r){var h=r.width/r.height,s=Math.min(r.width,a.maxWidth,h*a.maxHeight);return a.maxSize>0&&a.maxSize<r.width*r.height/1e3&&(s=Math.min(s,Math.floor(1e3*a.maxSize/r.height))),a.scaleRatio&&(s=Math.min(s,Math.floor(a.scaleRatio*r.width))),a.debug&&(console.log("browser-image-resizer: original image size = "+r.width+" px (width) X "+r.height+" px (height)"),console.log("browser-image-resizer: scaled image size = "+s+" px (width) X "+Math.floor(s/h)+" px (height)")),s<=0&&(s=1,console.warn("browser-image-resizer: image size is too small")),s}function q(a,r){var h=document.createElement("canvas"),s=r.outputWidth/a.width;h.width=a.width*s,h.height=a.height*s;var j=a.getContext("2d").getImageData(0,0,a.width,a.height),u=h.getContext("2d").createImageData(h.width,h.height);return function(l,P,_){function Q(n,b,te,R,ne,ae){var de=1-ne,ue=1-ae;return n*de*ue+b*ne*ue+te*de*ae+R*ne*ae}var x,U,g,p,L,N,D,o,k,f,y,M,E,$,G,V,H,ee,t;for(x=0;x<P.height;++x)for(g=x/_,p=Math.floor(g),L=Math.ceil(g)>l.height-1?l.height-1:Math.ceil(g),U=0;U<P.width;++U)N=U/_,D=Math.floor(N),o=Math.ceil(N)>l.width-1?l.width-1:Math.ceil(N),k=4*(U+P.width*x),f=4*(D+l.width*p),y=4*(o+l.width*p),M=4*(D+l.width*L),E=4*(o+l.width*L),$=N-D,G=g-p,V=Q(l.data[f],l.data[y],l.data[M],l.data[E],$,G),P.data[k]=V,H=Q(l.data[f+1],l.data[y+1],l.data[M+1],l.data[E+1],$,G),P.data[k+1]=H,ee=Q(l.data[f+2],l.data[y+2],l.data[M+2],l.data[E+2],$,G),P.data[k+2]=ee,t=Q(l.data[f+3],l.data[y+3],l.data[M+3],l.data[E+3],$,G),P.data[k+3]=t}(j,u,s),h.getContext("2d").putImageData(u,0,0),h}function O(a){var r=document.createElement("canvas");return r.width=a.width/2,r.height=a.height/2,r.getContext("2d").drawImage(a,0,0,r.width,r.height),r}c.r(d),c.d(d,{readAndCompressImage:()=>W});var z={quality:.5,maxWidth:800,maxHeight:600,autoRotate:!0,debug:!1,mimeType:"image/jpeg"};function W(a,r){return new Promise(function(h,s){var j=document.createElement("img"),u=new FileReader,l=Object.assign({},z,r);u.onload=function(P){j.onerror=function(){s("cannot load image.")},j.onload=function(){var _={img:j,config:l};try{var Q=function(){var x=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},U=x.img,g=x.config,p=(x.orientation,v());p.width=U.width,p.height=U.height;var L=p.getContext("2d");g.mimeType==="image/jpeg"&&(L.fillStyle="#ffffff",L.fillRect(0,0,p.width,p.height),L.save()),L.drawImage(U,0,0),L.restore();for(var N=A(g,p);p.width>=2*N;)p=O(p);p.width>N&&(p=q(p,Object.assign(g,{outputWidth:N})));var D=p.toDataURL(g.mimeType,g.quality);return typeof g.onScale=="function"&&g.onScale(D),w(D)}(_);h(Q)}catch(x){s(x)}},j.src=P.target.result};try{u.onerror=function(){s("cannot read image file.")},u.readAsDataURL(a)}catch(P){s(P)}})}return d})())})(Ce);var xe=Ce.exports;const Je=i=>ce(`/api/photos?handle=${i}`,{errorMessage:"Failed to upload photo",convertToFormData:!0}),Xe=(i,m)=>ce(`/api/photos/id/${i}/delete?handle=${m}`,{errorMessage:"Failed to delete photo"}),Ve=(i,m)=>ve(`/api/photos/id/${i}?handle=${m}`,{errorMessage:"Failed to get photo"}),fe={quality:.5,maxWidth:800*2,maxHeight:600*2,debug:!0},ye=({photoId:i,isMain:m,handle:c,onPhotoUploaded:d,onPhotoRemoved:v,onSetMainPhoto:w,onPhotoProcessingStart:A,onPhotoProcessingEnd:q})=>{const[O,z]=Z.useState(null),[W,a]=Z.useState(null),[r,h]=Z.useState(0),s=Ie(),j=Je(c),u=Xe(i||"",c),l=Ve(i||"",c),{data:P,isLoading:_,error:Q}=we(["photo",i,c],()=>l(),{enabled:!!i,onError:o=>{X.error(`Failed to load photo: ${re(o)}`)}}),x=oe(j,{onSuccess:o=>{o&&o.length>0&&(d(o[0]),z(null),a(null),X.success("Photo uploaded successfully"),q())},onError:o=>{X.error(`Failed to upload photo: ${re(o)}`),q()}}),U=oe(u,{onSuccess:()=>{v(),s.invalidateQueries(["photo",i,c]),X.success("Photo deleted successfully")},onError:o=>{X.error(`Failed to delete photo: ${re(o)}`)}}),g=async o=>{if(o.target.files&&o.target.files[0]){A();const k=o.target.files[0];try{const f=await xe.readAndCompressImage(k,fe),y=new File([f],"resizedImage.jpg",{type:"image/jpeg"});z(y),a(URL.createObjectURL(y))}catch(f){X.error(`Failed to process image: ${re(f)}`),q()}}},p=async()=>{if(O){A();try{const o=new Image;o.src=URL.createObjectURL(O),await new Promise((k,f)=>{o.onload=()=>{const y=document.createElement("canvas"),M=y.getContext("2d");if(!M){f(new Error("Failed to get canvas context"));return}const E=(r+90)%360,$=E===90||E===270?o.height:o.width,G=E===90||E===270?o.width:o.height;y.width=$,y.height=G,M.save(),M.translate(y.width/2,y.height/2),M.rotate(E*Math.PI/180),M.drawImage(o,-o.width/2,-o.height/2),M.restore(),y.toBlob(async V=>{if(!V){f(new Error("Failed to create blob"));return}try{const H=new File([V],"rotated.jpg",{type:"image/jpeg"}),ee=await xe.readAndCompressImage(H,fe),t=new File([ee],"rotated.jpg",{type:"image/jpeg"});z(t),a(URL.createObjectURL(t)),h(E),k(null)}catch(H){f(H)}},"image/jpeg",1)},o.onerror=()=>f(new Error("Failed to load image"))})}catch(o){X.error(`Failed to rotate image: ${re(o)}`)}finally{q()}}},L=async()=>{if(!O)return;const o=new FormData;o.append("file",O),o.append("fileName",O.name),x.mutate(o)},N=async()=>{i&&U.mutate({id:i})},D=()=>{z(null),a(null);const o=document.getElementById(`photo-upload-${i||"new"}`);o&&(o.value=""),q()};return Z.useEffect(()=>()=>{W&&URL.revokeObjectURL(W)},[W]),_||x.isLoading||U.isLoading?e.jsx(Ue,{}):Q?e.jsx(se,{error:Q}):e.jsx(e.Fragment,{children:i?e.jsxs("div",{className:"position-relative",children:[e.jsx("img",{src:(P==null?void 0:P.imageUrlMd)||"",alt:"Listing",className:"img-fluid mb-2"}),m&&e.jsxs(je,{color:"warning",className:"position-absolute top-0 start-0 m-2",children:[e.jsx(ie,{icon:he})," Main Photo"]}),e.jsxs("div",{children:[e.jsx(K,{color:"danger",onClick:N,className:"me-2",disabled:U.isLoading,children:U.isLoading?"Deleting...":"Delete"}),!m&&e.jsx(K,{color:"primary",onClick:w,children:"Set as Main"})]})]}):e.jsxs(S,{children:[e.jsx(C,{for:`photo-upload-${i||"new"}`,children:"Upload Photo"}),e.jsx(Ae,{type:"file",id:`photo-upload-${i||"new"}`,onChange:g,accept:"image/*"}),W&&e.jsx(Pe,{className:"mt-3",children:e.jsxs(be,{children:[e.jsx(Se,{tag:"h5",children:"Preview"}),e.jsxs("div",{className:"position-relative",children:[e.jsx(ze,{top:!0,width:"100%",src:W,alt:"Preview"}),m&&e.jsxs(je,{color:"warning",className:"position-absolute top-0 start-0 m-2",children:[e.jsx(ie,{icon:he})," ","Main Photo"]})]}),e.jsxs("div",{className:"d-flex justify-content-between mt-2",children:[e.jsxs(K,{color:"secondary",onClick:D,children:[e.jsx(ie,{icon:Fe})," ","Cancel"]}),e.jsxs(K,{color:"primary",onClick:p,children:[e.jsx(ie,{icon:Te})," Rotate"]}),e.jsx(K,{color:"success",onClick:L,disabled:x.isLoading,children:x.isLoading?"Uploading...":"Upload"})]})]})})]})})},Ye=i=>ce(`/api/inventory?handle=${i}`,{errorMessage:"Failed to upsert inventory item"}),Ke=(i,m)=>ve(`/api/inventory/${m}?handle=${i}`,{errorMessage:"Failed to get item"}),Ze="00000000-0000-0000-0000-000000000000",yt=({handle:i,storeInfo:m,itemId:c,onSave:d,onCancel:v,initialPhotos:w=[],onPhotoDeleted:A})=>{const q=c==="_",[O,z]=Z.useState(!1),[W,a]=Z.useState(null),{control:r,handleSubmit:h,setValue:s,watch:j,formState:{errors:u,isSubmitting:l}}=De({defaultValues:{id:Ze,code:"",name:"",description:"",category:"",jewelleryClass:null,condition:"",era:"",privateNote:"",unitPricing:J.SingleItem,stockQuantity:1,minimumPurchaseQuantity:1,unitType:"",unitPrice:0,costPrice:0,shippingAndPackaging:0,publish:!0,currency:m.currency,photos:[]}});Z.useEffect(()=>{if(w.length>0){const t=w.map((n,b)=>({main:b===0,ordinal:b,photoId:n.photoId,imageUrlSm:n.imageUrlSm,imageUrlMd:n.imageUrlMd,imageUrlLg:n.imageUrlLg}));s("photos",t)}},[w,s]);const P=Ke(i,c||""),{error:_,isLoading:Q,refetch:x}=we(["item",c],()=>P(),{enabled:!q&&!!c,onSuccess:t=>{t&&Object.entries(t).forEach(([n,b])=>{if(n==="photos"){const te=b.map(R=>({main:R.main,ordinal:R.ordinal,photoId:R.photoId||"",imageUrlSm:R.imageUrlSm,imageUrlMd:R.imageUrlMd,imageUrlLg:R.imageUrlLg}));s("photos",te)}else n==="store"||s(n,b)})}}),U=Ye(i),g=oe(U,{onSuccess:t=>{X.success("Item saved"),d(t,q,async()=>{await x()})},onError:t=>{a(re(t))}}),p=t=>{if(O){X.error("Please wait for all photos to finish uploading before submitting.");return}g.mutate(t)},L=t=>{const n=j("photos")||[],b={main:n.length===0,ordinal:n.length,photoId:t.photoId,imageUrlSm:t.imageUrlSm,imageUrlMd:t.imageUrlMd,imageUrlLg:t.imageUrlLg};s("photos",[...n,b]),z(!1)},N=()=>{z(!0)},D=()=>{z(!1)},o=t=>{const b=(j("photos")||[]).filter((te,R)=>R!==t);s("photos",b),A&&A()},k=t=>{const b=(j("photos")||[]).map((te,R)=>({...te,main:R===t}));s("photos",b)},f=j("category"),y=j("photos")||[],M=j("unitPricing"),E=j("unitType"),$=f in pe?pe[f]:Qe,G=t=>{s("unitPricing",t),s("stockQuantity",1),s("minimumPurchaseQuantity",1),t===J.ByUnit?s("unitType",Be.Metre):s("unitType","")},V=()=>{switch(M){case J.MultipleItems:return H();case J.ByUnit:return e.jsxs(e.Fragment,{children:[e.jsxs(S,{children:[e.jsx(C,{for:"unitType",children:"Unit Type"}),e.jsx(I,{name:"unitType",control:r,rules:{required:"Unit type is required"},render:({field:t})=>e.jsxs(F,{field:t,id:"unitType",type:"select",children:[e.jsx("option",{value:"",children:"Select unit type"}),Object.entries(ge).map(([n,b])=>e.jsx("option",{value:n,children:b},n))]})}),e.jsx(B,{error:u.unitType,fieldDisplayName:"Unit Type"})]}),H(),e.jsxs(S,{children:[e.jsx(C,{for:"minimumPurchaseQuantity",children:"Minimum Purchase Quantity"}),e.jsx(I,{name:"minimumPurchaseQuantity",control:r,rules:{required:"Minimum purchase quantity is required"},render:({field:t})=>e.jsx(F,{field:t,id:"minimumPurchaseQuantity",type:"number",min:"1"})}),e.jsx(B,{error:u.minimumPurchaseQuantity,fieldDisplayName:"Minimum Purchase Quantity"})]})]});default:return null}},H=()=>e.jsxs(S,{children:[e.jsx(C,{for:"stockQuantity",children:"Stock Quantity"}),e.jsx(I,{name:"stockQuantity",control:r,rules:{required:"Stock quantity is required"},render:({field:t})=>e.jsx(F,{field:t,id:"stockQuantity",type:"number",min:"0"})}),e.jsx(B,{error:u.stockQuantity,fieldDisplayName:"Stock Quantity"})]}),ee=(()=>{switch(M){case J.MultipleItems:return"Price each";case J.ByUnit:return`Price per ${ge[E]}`;default:return"Price"}})();return Q?e.jsx(Ue,{}):_?e.jsx(se,{error:_}):e.jsxs(Pe,{children:[e.jsx(Re,{children:e.jsx("h2",{children:q?"Create New Listing":"Edit Listing"})}),e.jsx(be,{children:e.jsxs(Oe,{onSubmit:h(p),children:[e.jsxs(Y,{children:[e.jsx(T,{md:6,children:e.jsxs(S,{children:[e.jsx(C,{for:"name",children:"Name"}),e.jsx(I,{name:"name",control:r,rules:{required:"Name is required"},render:({field:t})=>e.jsx(F,{field:t,id:"name",placeholder:"Enter item name"})}),e.jsx(B,{error:u.name,fieldDisplayName:"Name"})]})}),e.jsx(T,{md:6,children:e.jsxs(S,{children:[e.jsx(C,{for:"category",children:"Category"}),e.jsx(I,{name:"category",control:r,rules:{required:"Category is required"},render:({field:t})=>e.jsxs(F,{field:t,id:"category",type:"select",children:[e.jsx("option",{value:"",children:"Select a category"}),qe.map(n=>e.jsx("option",{value:n.value,children:n.value},n.value))]})}),e.jsx(B,{error:u.category,fieldDisplayName:"Category"})]})})]}),f==="Jewellery"&&e.jsxs(Y,{children:[e.jsx(T,{md:6}),e.jsx(T,{md:6,children:e.jsxs(S,{children:[e.jsx(C,{for:"jewelleryClass",children:"Jewellery Type"}),e.jsx(I,{name:"jewelleryClass",control:r,rules:{required:"Jewellery type is required for jewellery items"},render:({field:t})=>e.jsxs(F,{field:t,id:"jewelleryClass",type:"select",children:[e.jsx("option",{value:"",children:"Select a jewellery type"}),ke.map(n=>e.jsx("option",{value:n.value,children:n.value},n.value))]})}),e.jsx(B,{error:u.jewelleryClass,fieldDisplayName:"Jewellery Type"})]})})]}),e.jsxs(Y,{children:[e.jsx(T,{md:6,children:e.jsxs(S,{children:[e.jsx(C,{for:"condition",children:"Condition"}),e.jsx(I,{name:"condition",control:r,rules:{required:"Condition is required"},render:({field:t})=>e.jsxs(F,{field:t,id:"condition",type:"select",children:[e.jsx("option",{value:"",children:"Select a condition"}),$==null?void 0:$.map(n=>e.jsx("option",{value:n.value,children:n.value},n.value))]})}),e.jsx(B,{error:u.condition,fieldDisplayName:"Condition"})]})}),e.jsx(T,{md:6,children:e.jsxs(S,{children:[e.jsx(C,{for:"era",children:"Era"}),e.jsx(I,{name:"era",control:r,rules:{required:"Era is required"},render:({field:t})=>e.jsxs(F,{field:t,id:"era",type:"select",children:[e.jsx("option",{value:"",children:"Select an era"}),$e.map(n=>e.jsx("option",{value:n.value,children:n.value},n.value))]})}),e.jsx(B,{error:u.era,fieldDisplayName:"Era"})]})})]}),e.jsxs(S,{children:[e.jsx(C,{for:"description",children:"Description"}),e.jsx(I,{name:"description",control:r,render:({field:t})=>e.jsx(F,{field:t,id:"description",type:"textarea",rows:5,placeholder:"Enter item description"})}),e.jsx(B,{error:u.description,fieldDisplayName:"Description"})]}),e.jsxs(Y,{children:[e.jsx(T,{md:6,children:e.jsxs(S,{children:[e.jsx(C,{for:"unitPricing",children:"Unit Pricing"}),e.jsx(I,{name:"unitPricing",control:r,rules:{required:"Unit pricing is required"},render:({field:t})=>e.jsxs(F,{field:t,id:"unitPricing",type:"select",onChange:n=>G(Number(n.target.value)),children:[e.jsx("option",{value:"",children:"Select unit pricing"}),e.jsx("option",{value:J.SingleItem,children:"Single Item"}),e.jsx("option",{value:J.MultipleItems,children:"Multiple Items"}),e.jsx("option",{value:J.ByUnit,children:"By Unit"})]})}),e.jsx(B,{error:u.unitPricing,fieldDisplayName:"Unit Pricing"})]})}),e.jsx(T,{md:6,children:V()})]}),e.jsxs(Y,{children:[e.jsx(T,{md:4,children:e.jsxs(S,{children:[e.jsx(C,{for:"unitPrice",children:ee}),e.jsx(I,{name:"unitPrice",control:r,rules:{required:"Price is required",validate:t=>t===void 0?"Price is required":t>0||"Price must be greater than 0"},render:({field:t})=>e.jsx(F,{field:t,id:"unitPrice",type:"number",step:"0.01",min:"0"})}),e.jsx(B,{error:u.unitPrice,fieldDisplayName:"Price"})]})}),e.jsx(T,{md:4,children:e.jsxs(S,{children:[e.jsx(C,{for:"costPrice",children:"Cost Price"}),e.jsx(I,{name:"costPrice",control:r,render:({field:t})=>e.jsx(F,{field:t,id:"costPrice",type:"number",step:"0.01",min:"0"})})]})}),e.jsx(T,{md:4,children:e.jsxs(S,{children:[e.jsx(C,{for:"publish",children:"Publish"}),e.jsx(I,{name:"publish",control:r,render:({field:t})=>e.jsxs(F,{field:t,id:"publish",type:"select",children:[e.jsx("option",{value:"true",children:"Yes"}),e.jsx("option",{value:"false",children:"No"})]})})]})})]}),e.jsxs(S,{children:[e.jsx(C,{for:"privateNote",children:"Private Note"}),e.jsx(I,{name:"privateNote",control:r,render:({field:t})=>e.jsx(F,{field:t,id:"privateNote",type:"textarea",rows:3,placeholder:"Enter private note (only visible to you)"})})]}),e.jsxs(S,{children:[e.jsx(C,{children:"Images"}),y.map((t,n)=>e.jsx(Y,{className:"mb-3",children:e.jsx(T,{md:12,children:e.jsx(ye,{handle:i,photoId:t.photoId,isMain:t.main,onPhotoUploaded:b=>L(b),onPhotoRemoved:()=>o(n),onSetMainPhoto:()=>k(n),onPhotoProcessingStart:N,onPhotoProcessingEnd:D})})},n)),e.jsx(Y,{children:e.jsx(T,{md:12,children:e.jsx(ye,{handle:i,photoId:null,isMain:y.length===0,onPhotoUploaded:t=>L(t),onPhotoRemoved:()=>{},onSetMainPhoto:()=>{},onPhotoProcessingStart:N,onPhotoProcessingEnd:D})})})]}),e.jsx(se,{error:W}),e.jsxs("div",{className:"d-flex justify-content-end",children:[e.jsx(K,{color:"secondary",className:"me-2",onClick:v,children:"Cancel"}),e.jsx(K,{color:"primary",type:"submit",disabled:g.isLoading||l||O,children:g.isLoading||l?"Saving...":O?"Waiting for photo upload...":q?"Create Listing":"Update Listing"})]})]})})]})};export{yt as E,ye as L};
