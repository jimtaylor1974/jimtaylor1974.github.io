import{u as le,w as fe,r as K,D as be,p as ye,j as e,F as ie,E as ue,B as Y,G as Se,H as Ce,Q as H,h as te,I as Me}from"./index-29ebecb4.js";import{u as Le,C as M}from"./index.esm-28c77aa9.js";import{u as se}from"./useMutation-742de80f.js";import{R as V,C as E}from"./Col-7106f25e.js";import{C as we,a as ve}from"./CardBody-f79b7743.js";import{C as Ee}from"./CardHeader-058da22c.js";import{F as Fe}from"./Form-feffa48a.js";import{F as v,L as P}from"./Label-25c4d9a0.js";import{U as W}from"./types-9dadba29.js";import{E as ae}from"./ErrorDisplay-926af4d8.js";import{S as Pe}from"./Spinner-99079439.js";import{G as L}from"./GenericInput-69b8ebf0.js";import{c as he,a as Ie,j as Ne,e as qe}from"./jewelleryClasses-0e5a29b0.js";import{D as k}from"./DisplayFormError-41029f3c.js";import{U as me,a as De}from"./UnitType-2ae5b94b.js";import{B as pe}from"./Badge-dcfa0ac5.js";import{C as Re}from"./CardImg-0d61cdbd.js";import{C as Te}from"./CardTitle-03adcecb.js";import{I as Qe}from"./Input-092d3532.js";var Ue={exports:{}};(function(l,F){(function(y,B){l.exports=B()})(self,()=>(()=>{var y={d:(n,r)=>{for(var d in r)y.o(r,d)&&!y.o(n,d)&&Object.defineProperty(n,d,{enumerable:!0,get:r[d]})},o:(n,r)=>Object.prototype.hasOwnProperty.call(n,r),r:n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})}},B={};function re(){return document.createElement("canvas")}function J(n){for(var r=atob(n.split(",")[1]),d=n.split(",")[0].split(":")[1].split(";")[0],s=new ArrayBuffer(r.length),m=new Uint8Array(s),c=0;c<r.length;c++)m[c]=r.charCodeAt(c);return new Blob([s],{type:d})}function _(n,r){var d=r.width/r.height,s=Math.min(r.width,n.maxWidth,d*n.maxHeight);return n.maxSize>0&&n.maxSize<r.width*r.height/1e3&&(s=Math.min(s,Math.floor(1e3*n.maxSize/r.height))),n.scaleRatio&&(s=Math.min(s,Math.floor(n.scaleRatio*r.width))),n.debug&&(console.log("browser-image-resizer: original image size = "+r.width+" px (width) X "+r.height+" px (height)"),console.log("browser-image-resizer: scaled image size = "+s+" px (width) X "+Math.floor(s/d)+" px (height)")),s<=0&&(s=1,console.warn("browser-image-resizer: image size is too small")),s}function I(n,r){var d=document.createElement("canvas"),s=r.outputWidth/n.width;d.width=n.width*s,d.height=n.height*s;var m=n.getContext("2d").getImageData(0,0,n.width,n.height),c=d.getContext("2d").createImageData(d.width,d.height);return function(a,j,O){function R(i,f,ee,q,ne,oe){var ce=1-ne,de=1-oe;return i*ce*de+f*ne*de+ee*ce*oe+q*ne*oe}var p,w,h,u,b,S,N,o,T,g,x,U,C,Q,A,X,G,Z,t;for(p=0;p<j.height;++p)for(h=p/O,u=Math.floor(h),b=Math.ceil(h)>a.height-1?a.height-1:Math.ceil(h),w=0;w<j.width;++w)S=w/O,N=Math.floor(S),o=Math.ceil(S)>a.width-1?a.width-1:Math.ceil(S),T=4*(w+j.width*p),g=4*(N+a.width*u),x=4*(o+a.width*u),U=4*(N+a.width*b),C=4*(o+a.width*b),Q=S-N,A=h-u,X=R(a.data[g],a.data[x],a.data[U],a.data[C],Q,A),j.data[T]=X,G=R(a.data[g+1],a.data[x+1],a.data[U+1],a.data[C+1],Q,A),j.data[T+1]=G,Z=R(a.data[g+2],a.data[x+2],a.data[U+2],a.data[C+2],Q,A),j.data[T+2]=Z,t=R(a.data[g+3],a.data[x+3],a.data[U+3],a.data[C+3],Q,A),j.data[T+3]=t}(m,c,s),d.getContext("2d").putImageData(c,0,0),d}function D(n){var r=document.createElement("canvas");return r.width=n.width/2,r.height=n.height/2,r.getContext("2d").drawImage(n,0,0,r.width,r.height),r}y.r(B),y.d(B,{readAndCompressImage:()=>z});var $={quality:.5,maxWidth:800,maxHeight:600,autoRotate:!0,debug:!1,mimeType:"image/jpeg"};function z(n,r){return new Promise(function(d,s){var m=document.createElement("img"),c=new FileReader,a=Object.assign({},$,r);c.onload=function(j){m.onerror=function(){s("cannot load image.")},m.onload=function(){var O={img:m,config:a};try{var R=function(){var p=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},w=p.img,h=p.config,u=(p.orientation,re());u.width=w.width,u.height=w.height;var b=u.getContext("2d");h.mimeType==="image/jpeg"&&(b.fillStyle="#ffffff",b.fillRect(0,0,u.width,u.height),b.save()),b.drawImage(w,0,0),b.restore();for(var S=_(h,u);u.width>=2*S;)u=D(u);u.width>S&&(u=I(u,Object.assign(h,{outputWidth:S})));var N=u.toDataURL(h.mimeType,h.quality);return typeof h.onScale=="function"&&h.onScale(N),J(N)}(O);d(R)}catch(p){s(p)}},m.src=j.target.result};try{c.onerror=function(){s("cannot read image file.")},c.readAsDataURL(n)}catch(j){s(j)}})}return B})())})(Ue);var ge=Ue.exports;const ke=l=>le(`/api/photos?handle=${l}`,{errorMessage:"Failed to upload photo",convertToFormData:!0}),$e=(l,F)=>le(`/api/photos/id/${l}/delete?handle=${F}`,{errorMessage:"Failed to delete photo"}),Be=(l,F)=>fe(`/api/photos/id/${l}?handle=${F}`,{errorMessage:"Failed to get photo"}),xe={quality:.5,maxWidth:800*2,maxHeight:600*2,debug:!0},je=({photoId:l,isMain:F,handle:y,onPhotoUploaded:B,onPhotoRemoved:re,onSetMainPhoto:J,onPhotoProcessingStart:_,onPhotoProcessingEnd:I})=>{const[D,$]=K.useState(null),[z,n]=K.useState(null),[r,d]=K.useState(0),s=be(),m=ke(y),c=$e(l||"",y),a=Be(l||"",y),{data:j,isLoading:O,error:R}=ye(["photo",l,y],()=>a(),{enabled:!!l,onError:o=>{H.error(`Failed to load photo: ${te(o)}`)}}),p=se(m,{onSuccess:o=>{o&&o.length>0&&(B(o[0]),$(null),n(null),H.success("Photo uploaded successfully"),I())},onError:o=>{H.error(`Failed to upload photo: ${te(o)}`),I()}}),w=se(c,{onSuccess:()=>{re(),s.invalidateQueries(["photo",l,y]),H.success("Photo deleted successfully")},onError:o=>{H.error(`Failed to delete photo: ${te(o)}`)}}),h=async o=>{if(o.target.files&&o.target.files[0]){_();const T=o.target.files[0];try{const g=await ge.readAndCompressImage(T,xe),x=new File([g],"resizedImage.jpg",{type:"image/jpeg"});$(x),n(URL.createObjectURL(x))}catch(g){H.error(`Failed to process image: ${te(g)}`),I()}}},u=async()=>{if(D){_();try{const o=new Image;o.src=URL.createObjectURL(D),await new Promise((T,g)=>{o.onload=()=>{const x=document.createElement("canvas"),U=x.getContext("2d");if(!U){g(new Error("Failed to get canvas context"));return}const C=(r+90)%360,Q=C===90||C===270?o.height:o.width,A=C===90||C===270?o.width:o.height;x.width=Q,x.height=A,U.save(),U.translate(x.width/2,x.height/2),U.rotate(C*Math.PI/180),U.drawImage(o,-o.width/2,-o.height/2),U.restore(),x.toBlob(async X=>{if(!X){g(new Error("Failed to create blob"));return}try{const G=new File([X],"rotated.jpg",{type:"image/jpeg"}),Z=await ge.readAndCompressImage(G,xe),t=new File([Z],"rotated.jpg",{type:"image/jpeg"});$(t),n(URL.createObjectURL(t)),d(C),T(null)}catch(G){g(G)}},"image/jpeg",1)},o.onerror=()=>g(new Error("Failed to load image"))})}catch(o){H.error(`Failed to rotate image: ${te(o)}`)}finally{I()}}},b=async()=>{if(!D)return;const o=new FormData;o.append("file",D),o.append("fileName",D.name),p.mutate(o)},S=async()=>{l&&w.mutate({id:l})},N=()=>{$(null),n(null);const o=document.getElementById(`photo-upload-${l||"new"}`);o&&(o.value=""),I()};return K.useEffect(()=>()=>{z&&URL.revokeObjectURL(z)},[z]),O||p.isLoading||w.isLoading?e.jsx(Pe,{}):R?e.jsx(ae,{error:R}):e.jsx(e.Fragment,{children:l?e.jsxs("div",{className:"position-relative",children:[e.jsx("img",{src:(j==null?void 0:j.imageUrlMd)||"",alt:"Listing",className:"img-fluid mb-2"}),F&&e.jsxs(pe,{color:"warning",className:"position-absolute top-0 start-0 m-2",children:[e.jsx(ie,{icon:ue})," Main Photo"]}),e.jsxs("div",{children:[e.jsx(Y,{color:"danger",onClick:S,className:"me-2",disabled:w.isLoading,children:w.isLoading?"Deleting...":"Delete"}),!F&&e.jsx(Y,{color:"primary",onClick:J,children:"Set as Main"})]})]}):e.jsxs(v,{children:[e.jsx(P,{for:`photo-upload-${l||"new"}`,children:"Upload Photo"}),e.jsx(Qe,{type:"file",id:`photo-upload-${l||"new"}`,onChange:h,accept:"image/*"}),z&&e.jsx(we,{className:"mt-3",children:e.jsxs(ve,{children:[e.jsx(Te,{tag:"h5",children:"Preview"}),e.jsxs("div",{className:"position-relative",children:[e.jsx(Re,{top:!0,width:"100%",src:z,alt:"Preview"}),F&&e.jsxs(pe,{color:"warning",className:"position-absolute top-0 start-0 m-2",children:[e.jsx(ie,{icon:ue})," ","Main Photo"]})]}),e.jsxs("div",{className:"d-flex justify-content-between mt-2",children:[e.jsxs(Y,{color:"secondary",onClick:N,children:[e.jsx(ie,{icon:Se})," ","Cancel"]}),e.jsxs(Y,{color:"primary",onClick:u,children:[e.jsx(ie,{icon:Ce})," Rotate"]}),e.jsx(Y,{color:"success",onClick:b,disabled:p.isLoading,children:p.isLoading?"Uploading...":"Upload"})]})]})})]})})},ze=l=>le(`/api/inventory?handle=${l}`,{errorMessage:"Failed to upsert inventory item"}),Oe=(l,F)=>fe(`/api/inventory/${F}?handle=${l}`,{errorMessage:"Failed to get item"}),Ae="00000000-0000-0000-0000-000000000000",ct=({handle:l,storeInfo:F,itemId:y,onSave:B,onCancel:re,initialPhotos:J=[],onPhotoDeleted:_})=>{const I=y==="_",[D,$]=K.useState(!1),[z,n]=K.useState(null),{control:r,handleSubmit:d,setValue:s,watch:m,formState:{errors:c,isSubmitting:a}}=Le({defaultValues:{id:Ae,code:"",name:"",description:"",category:"",jewelleryClass:null,condition:"",era:"",privateNote:"",unitPricing:W.SingleItem,stockQuantity:1,minimumPurchaseQuantity:1,unitType:"",unitPrice:0,costPrice:0,shippingAndPackaging:0,publish:!0,currency:F.currency,photos:[]}});K.useEffect(()=>{if(J.length>0){const t=J.map((i,f)=>({main:f===0,ordinal:f,photoId:i.photoId,imageUrlSm:i.imageUrlSm,imageUrlMd:i.imageUrlMd,imageUrlLg:i.imageUrlLg}));s("photos",t)}},[J,s]);const j=Oe(l,y||""),{error:O,isLoading:R,refetch:p}=ye(["item",y],()=>j(),{enabled:!I&&!!y,onSuccess:t=>{t&&Object.entries(t).forEach(([i,f])=>{if(i==="photos"){const ee=f.map(q=>({main:q.main,ordinal:q.ordinal,photoId:q.photoId||"",imageUrlSm:q.imageUrlSm,imageUrlMd:q.imageUrlMd,imageUrlLg:q.imageUrlLg}));s("photos",ee)}else i==="store"||s(i,f)})}}),w=ze(l),h=se(w,{onSuccess:t=>{H.success("Item saved"),B(t,I,async()=>{await p()})},onError:t=>{n(te(t))}}),u=t=>{if(D){H.error("Please wait for all photos to finish uploading before submitting.");return}h.mutate(t)},b=t=>{const i=m("photos")||[],f={main:i.length===0,ordinal:i.length,photoId:t.photoId,imageUrlSm:t.imageUrlSm,imageUrlMd:t.imageUrlMd,imageUrlLg:t.imageUrlLg};s("photos",[...i,f]),$(!1)},S=()=>{$(!0)},N=()=>{$(!1)},o=t=>{const f=(m("photos")||[]).filter((ee,q)=>q!==t);s("photos",f),_&&_()},T=t=>{const f=(m("photos")||[]).map((ee,q)=>({...ee,main:q===t}));s("photos",f)},g=m("category"),x=m("photos")||[],U=m("unitPricing"),C=m("unitType"),Q=g in he?he[g]:Ie,A=t=>{s("unitPricing",t),s("stockQuantity",1),s("minimumPurchaseQuantity",1),t===W.ByUnit?s("unitType",De.Metre):s("unitType","")},X=()=>{switch(U){case W.MultipleItems:return G();case W.ByUnit:return e.jsxs(e.Fragment,{children:[e.jsxs(v,{children:[e.jsx(P,{for:"unitType",children:"Unit Type"}),e.jsx(M,{name:"unitType",control:r,rules:{required:"Unit type is required"},render:({field:t})=>e.jsxs(L,{field:t,id:"unitType",type:"select",children:[e.jsx("option",{value:"",children:"Select unit type"}),Object.entries(me).map(([i,f])=>e.jsx("option",{value:i,children:f},i))]})}),e.jsx(k,{error:c.unitType,fieldDisplayName:"Unit Type"})]}),G(),e.jsxs(v,{children:[e.jsx(P,{for:"minimumPurchaseQuantity",children:"Minimum Purchase Quantity"}),e.jsx(M,{name:"minimumPurchaseQuantity",control:r,rules:{required:"Minimum purchase quantity is required"},render:({field:t})=>e.jsx(L,{field:t,id:"minimumPurchaseQuantity",type:"number",min:"1"})}),e.jsx(k,{error:c.minimumPurchaseQuantity,fieldDisplayName:"Minimum Purchase Quantity"})]})]});default:return null}},G=()=>e.jsxs(v,{children:[e.jsx(P,{for:"stockQuantity",children:"Stock Quantity"}),e.jsx(M,{name:"stockQuantity",control:r,rules:{required:"Stock quantity is required"},render:({field:t})=>e.jsx(L,{field:t,id:"stockQuantity",type:"number",min:"0"})}),e.jsx(k,{error:c.stockQuantity,fieldDisplayName:"Stock Quantity"})]}),Z=(()=>{switch(U){case W.MultipleItems:return"Price each";case W.ByUnit:return`Price per ${me[C]}`;default:return"Price"}})();return R?e.jsx(Pe,{}):O?e.jsx(ae,{error:O}):e.jsxs(we,{children:[e.jsx(Ee,{children:e.jsx("h2",{children:I?"Create New Listing":"Edit Listing"})}),e.jsx(ve,{children:e.jsxs(Fe,{onSubmit:d(u),children:[e.jsxs(V,{children:[e.jsx(E,{md:6,children:e.jsxs(v,{children:[e.jsx(P,{for:"name",children:"Name"}),e.jsx(M,{name:"name",control:r,rules:{required:"Name is required"},render:({field:t})=>e.jsx(L,{field:t,id:"name",placeholder:"Enter item name"})}),e.jsx(k,{error:c.name,fieldDisplayName:"Name"})]})}),e.jsx(E,{md:6,children:e.jsxs(v,{children:[e.jsx(P,{for:"category",children:"Category"}),e.jsx(M,{name:"category",control:r,rules:{required:"Category is required"},render:({field:t})=>e.jsxs(L,{field:t,id:"category",type:"select",children:[e.jsx("option",{value:"",children:"Select a category"}),Me.map(i=>e.jsx("option",{value:i.value,children:i.value},i.value))]})}),e.jsx(k,{error:c.category,fieldDisplayName:"Category"})]})})]}),g==="Jewellery"&&e.jsxs(V,{children:[e.jsx(E,{md:6}),e.jsx(E,{md:6,children:e.jsxs(v,{children:[e.jsx(P,{for:"jewelleryClass",children:"Jewellery Type"}),e.jsx(M,{name:"jewelleryClass",control:r,rules:{required:"Jewellery type is required for jewellery items"},render:({field:t})=>e.jsxs(L,{field:t,id:"jewelleryClass",type:"select",children:[e.jsx("option",{value:"",children:"Select a jewellery type"}),Ne.map(i=>e.jsx("option",{value:i.value,children:i.value},i.value))]})}),e.jsx(k,{error:c.jewelleryClass,fieldDisplayName:"Jewellery Type"})]})})]}),e.jsxs(V,{children:[e.jsx(E,{md:6,children:e.jsxs(v,{children:[e.jsx(P,{for:"condition",children:"Condition"}),e.jsx(M,{name:"condition",control:r,rules:{required:"Condition is required"},render:({field:t})=>e.jsxs(L,{field:t,id:"condition",type:"select",children:[e.jsx("option",{value:"",children:"Select a condition"}),Q==null?void 0:Q.map(i=>e.jsx("option",{value:i.value,children:i.value},i.value))]})}),e.jsx(k,{error:c.condition,fieldDisplayName:"Condition"})]})}),e.jsx(E,{md:6,children:e.jsxs(v,{children:[e.jsx(P,{for:"era",children:"Era"}),e.jsx(M,{name:"era",control:r,rules:{required:"Era is required"},render:({field:t})=>e.jsxs(L,{field:t,id:"era",type:"select",children:[e.jsx("option",{value:"",children:"Select an era"}),qe.map(i=>e.jsx("option",{value:i.value,children:i.value},i.value))]})}),e.jsx(k,{error:c.era,fieldDisplayName:"Era"})]})})]}),e.jsxs(v,{children:[e.jsx(P,{for:"description",children:"Description"}),e.jsx(M,{name:"description",control:r,render:({field:t})=>e.jsx(L,{field:t,id:"description",type:"textarea",rows:5,placeholder:"Enter item description"})}),e.jsx(k,{error:c.description,fieldDisplayName:"Description"})]}),e.jsxs(V,{children:[e.jsx(E,{md:6,children:e.jsxs(v,{children:[e.jsx(P,{for:"unitPricing",children:"Unit Pricing"}),e.jsx(M,{name:"unitPricing",control:r,rules:{required:"Unit pricing is required"},render:({field:t})=>e.jsxs(L,{field:t,id:"unitPricing",type:"select",onChange:i=>A(Number(i.target.value)),children:[e.jsx("option",{value:"",children:"Select unit pricing"}),e.jsx("option",{value:W.SingleItem,children:"Single Item"}),e.jsx("option",{value:W.MultipleItems,children:"Multiple Items"}),e.jsx("option",{value:W.ByUnit,children:"By Unit"})]})}),e.jsx(k,{error:c.unitPricing,fieldDisplayName:"Unit Pricing"})]})}),e.jsx(E,{md:6,children:X()})]}),e.jsxs(V,{children:[e.jsx(E,{md:4,children:e.jsxs(v,{children:[e.jsx(P,{for:"unitPrice",children:Z}),e.jsx(M,{name:"unitPrice",control:r,rules:{required:"Price is required",validate:t=>t===void 0?"Price is required":t>0||"Price must be greater than 0"},render:({field:t})=>e.jsx(L,{field:t,id:"unitPrice",type:"number",step:"0.01",min:"0"})}),e.jsx(k,{error:c.unitPrice,fieldDisplayName:"Price"})]})}),e.jsx(E,{md:4,children:e.jsxs(v,{children:[e.jsx(P,{for:"costPrice",children:"Cost Price"}),e.jsx(M,{name:"costPrice",control:r,render:({field:t})=>e.jsx(L,{field:t,id:"costPrice",type:"number",step:"0.01",min:"0"})})]})}),e.jsx(E,{md:4,children:e.jsxs(v,{children:[e.jsx(P,{for:"publish",children:"Publish"}),e.jsx(M,{name:"publish",control:r,render:({field:t})=>e.jsxs(L,{field:t,id:"publish",type:"select",children:[e.jsx("option",{value:"true",children:"Yes"}),e.jsx("option",{value:"false",children:"No"})]})})]})})]}),e.jsxs(v,{children:[e.jsx(P,{for:"privateNote",children:"Private Note"}),e.jsx(M,{name:"privateNote",control:r,render:({field:t})=>e.jsx(L,{field:t,id:"privateNote",type:"textarea",rows:3,placeholder:"Enter private note (only visible to you)"})})]}),e.jsxs(v,{children:[e.jsx(P,{children:"Images"}),x.map((t,i)=>e.jsx(V,{className:"mb-3",children:e.jsx(E,{md:12,children:e.jsx(je,{handle:l,photoId:t.photoId,isMain:t.main,onPhotoUploaded:f=>b(f),onPhotoRemoved:()=>o(i),onSetMainPhoto:()=>T(i),onPhotoProcessingStart:S,onPhotoProcessingEnd:N})})},i)),e.jsx(V,{children:e.jsx(E,{md:12,children:e.jsx(je,{handle:l,photoId:null,isMain:x.length===0,onPhotoUploaded:t=>b(t),onPhotoRemoved:()=>{},onSetMainPhoto:()=>{},onPhotoProcessingStart:S,onPhotoProcessingEnd:N})})})]}),e.jsx(ae,{error:z}),e.jsxs("div",{className:"d-flex justify-content-end",children:[e.jsx(Y,{color:"secondary",className:"me-2",onClick:re,children:"Cancel"}),e.jsx(Y,{color:"primary",type:"submit",disabled:h.isLoading||a||D,children:h.isLoading||a?"Saving...":D?"Waiting for photo upload...":I?"Create Listing":"Update Listing"})]})]})})]})};export{ct as E,je as L};
